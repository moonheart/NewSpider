## NewSpider

A distributed spider

### Design

#### 门户

+ 添加项目: 名称、git链接、用户名、密码
+ 在 git 服务上添加 WebHooks
+ 在项目下面创建任务: 名称、cron、镜像选择、运行参数、备注
+ WebHooks 回调接口: 检查 Tag 是否符合 $"{Release}:{Name}:{Version}"，如果符合则执行 docker 镜像编译脚本，编译成功则把相应数据入库供创建任务使用选择
+ 暂停任务: 任务订阅 “job name"，发送 `暂停消息`
+ 继续任务: 任务订阅 “job name"，发送 `继续消息`
+ 重启任务: 任务订阅 “job name"，发送 `退出消息`，重启 Docker 实例(如果有版本更新会先更新)
+ 查询所有下载服务的状态
+ 查询任务所用的下载服务
+ 查询任务队列的信息: Left、Total、Success、Faild
+ 查询任务日志: 通过消息队列入库到 ES

#### 下载器服务

+ 下载服务以心跳方式注册到下载管理中心，上报内容有: 下载器标识、下载服务器内存开销、CPU 开销、活跃的 HttpClient 数、QPS
+ 下载服务订阅 `下载器标识` 来获取下载任务
+ 下载服务以任务标识隔离 HttpClient
+ 下载服务定时释放不再使用的 HttpClient
+ 下载服务支持按照规则截取下载内容(减少回传网络流量)
+ 下载服务支持设置代理、ADSL 并且支持使用正则判断切换代理或 ADSL

#### 下载管理中心

所有的下载请求统一到下载管理中心，下载管理中心通过任务配置的策略分发下载任务。

+ 所有下载器随机分配
+ 随机分配 n 个下载器服务后固定使用这 n 个下载器
+ 随机分配 n 个下载器服务后固定使用这 n 个下载器, 并且由 m 下载器内容解析到的目标请求仍需要回到 m 下载器下载

#### 调度服务

以 `名称` + `任务标识` 唯度管理请求调度

#### EventBus

通过事件总解藕各个组件，通过 Kafka 等消息队列实现分布式的统一管理


#### 设计图

```
                                  +----------------------+  +----------------------+     
                                  | Downloader Manager   |  |      Scheduler       |    
+----------------------+          +----------^-----------+  +----------^-----------+   
| Downloader Service 1 +----+                |                         |               
+----------------------+    |                |                         |                 
                            |     +----------v----------EventBus-------v-----------+
+----------------------+    |     |  +-------+       +----------+       +-------+  |
| Downloader Service 2 +----+<---->  | Local |       | RabbitMq |       | Kafka |  |
+----------------------+    |     |  +-------+       +----------+       +-------+  |
                            |     +-----------------------^------------------------+
+----------------------+    |                             |
| Downloader Service 3 +----+     +-----------------------v--------Portal----------+
+----------------------+          |    +-----------+  +----------+  +----------+   |
                                  |    | Processor |->| Pipeline |->| ETL...   |   |   +--------------------------+
                                  |    +-----------+  +----------+  +----------+   +--->  MySql, SqlServer, etc   |
                                  |    +-----------+  +----------+  +----------+   |   +-----------+--------------+
                                  |    | Processor |->| Pipeline |->| ETL...   |   |               |
                                  |    +-----------+  +----------+  +----------+   |               |
                                  |    +-----------+  +----------+  +----------+   |        +------v--------+
                                  |    | Processor |->| Pipeline |->| ETL...   |   |        |  ClickHouse   |
                                  |    +-----------+  +----------+  +----------+   |        +---------------+         
                                  +------------------------------------------------+  




``` 
